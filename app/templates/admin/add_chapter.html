{% extends "base.html" %} {% block title %}Th√™m Ch∆∞∆°ng{% endblock %} {% block
content %}
<div class="container">
  <h1 class="my-4">Th√™m Ch∆∞∆°ng cho "{{ comic.title }}"</h1>
  <form
    method="POST"
    action="{{ url_for('admin.add_chapter', comic_id=comic.id) }}"
    enctype="multipart/form-data"
  >
    <div class="mb-3">
      <label for="chapter_number" class="form-label">S·ªë Ch∆∞∆°ng</label>
      <input
        type="number"
        step="0.1"
        class="form-control"
        id="chapter_number"
        name="chapter_number"
        required
      />
    </div>
    <div class="mb-3">
      <label for="title" class="form-label">Ti√™u ƒê·ªÅ Ch∆∞∆°ng (t√πy ch·ªçn)</label>
      <input type="text" class="form-control" id="title" name="title" />
    </div>
    <div class="mb-3">
      <label class="form-label">·∫¢nh Ch∆∞∆°ng</label>

      <!-- Tab navigation -->
      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="upload-tab"
            data-bs-toggle="tab"
            data-bs-target="#upload-panel"
            type="button"
            role="tab"
          >
            üì§ Upload t·ª´ m√°y
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="url-tab"
            data-bs-toggle="tab"
            data-bs-target="#url-panel"
            type="button"
            role="tab"
          >
            üîó D√πng URL
          </button>
        </li>
      </ul>

      <!-- Tab content -->
      <div class="tab-content border border-top-0 p-3">
        <!-- Upload panel -->
        <div
          class="tab-pane fade show active"
          id="upload-panel"
          role="tabpanel"
        >
          <input
            type="file"
            class="form-control"
            id="chapter_images"
            name="chapter_images"
            accept="image/png,image/jpeg,image/jpg,image/gif,image/webp"
            multiple
            onchange="previewImages(this)"
          />
          <small class="text-muted d-block mt-2">
            <i class="fas fa-info-circle"></i>
            Ch·ªçn nhi·ªÅu ·∫£nh c√πng l√∫c (Ctrl/Cmd + Click). Upload l√™n ImgBB. H·ªó
            tr·ª£: PNG, JPG, GIF, WEBP. M·ªói file t·ªëi ƒëa 10MB.
          </small>

          <!-- Image preview gallery -->
          <div id="images-preview" class="mt-3" style="display: none">
            <p class="mb-2">
              <strong>Preview (<span id="image-count">0</span> ·∫£nh):</strong>
            </p>
            <div id="preview-gallery" class="row g-2"></div>
            <div class="alert alert-info mt-3">
              <i class="fas fa-cloud-upload-alt"></i> C√°c ·∫£nh s·∫Ω ƒë∆∞·ª£c upload l√™n
              ImgBB khi b·∫°n submit form.
            </div>
          </div>
        </div>

        <!-- URL panel -->
        <div class="tab-pane fade" id="url-panel" role="tabpanel">
          <textarea
            class="form-control"
            id="image_urls"
            name="image_urls"
            rows="10"
            placeholder="https://example.com/image1.jpg
https://example.com/image2.jpg
https://example.com/image3.jpg"
          ></textarea>
          <small class="text-muted d-block mt-2">
            <i class="fas fa-link"></i>
            Nh·∫≠p URL c·ªßa ·∫£nh (m·ªói URL m·ªôt d√≤ng)
          </small>
        </div>
      </div>
    </div>
    <button type="submit" class="btn btn-primary" id="submit-btn">
      <i class="fas fa-plus-circle"></i> Th√™m Ch∆∞∆°ng
    </button>
    <a
      href="{{ url_for('comic.view_comic', comic_id=comic.id) }}"
      class="btn btn-secondary"
    >
      <i class="fas fa-times"></i> H·ªßy
    </a>
  </form>
</div>

<script>
  // Image preview function for multiple files
  function previewImages(input) {
    const previewContainer = document.getElementById("images-preview");
    const previewGallery = document.getElementById("preview-gallery");
    const imageCount = document.getElementById("image-count");

    if (input.files && input.files.length > 0) {
      previewGallery.innerHTML = "";
      imageCount.textContent = input.files.length;

      let totalSize = 0;
      let hasOversizedFile = false;

      Array.from(input.files).forEach((file, index) => {
        totalSize += file.size;
        const sizeMB = (file.size / (1024 * 1024)).toFixed(2);

        if (file.size > 10 * 1024 * 1024) {
          hasOversizedFile = true;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const col = document.createElement("div");
          col.className = "col-6 col-md-3";
          col.innerHTML = `
            <div class="card">
              <img src="${e.target.result}" class="card-img-top" alt="Preview ${
            index + 1
          }" style="height: 150px; object-fit: cover;">
              <div class="card-body p-2">
                <small class="text-muted d-block text-truncate" title="${
                  file.name
                }">
                  ${index + 1}. ${file.name}
                </small>
                <small class="${
                  file.size > 10 * 1024 * 1024 ? "text-danger" : "text-muted"
                }">
                  ${sizeMB} MB ${file.size > 10 * 1024 * 1024 ? "‚ö†Ô∏è" : ""}
                </small>
              </div>
            </div>
          `;
          previewGallery.appendChild(col);
        };
        reader.readAsDataURL(file);
      });

      if (hasOversizedFile) {
        alert(
          "‚ö†Ô∏è M·ªôt s·ªë file l·ªõn h∆°n 10MB. Nh·ªØng file n√†y c√≥ th·ªÉ b·ªã t·ª´ ch·ªëi khi upload."
        );
      }

      const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
      console.log(`Total size: ${totalSizeMB} MB`);

      previewContainer.style.display = "block";
    } else {
      previewContainer.style.display = "none";
    }
  }

  // Show loading state on form submit
  document.querySelector("form").addEventListener("submit", function (e) {
    const fileInput = document.getElementById("chapter_images");
    const submitBtn = document.getElementById("submit-btn");

    if (fileInput.files && fileInput.files.length > 0) {
      submitBtn.disabled = true;
      submitBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin"></i> ƒêang upload ·∫£nh l√™n cloud...';
    }
  });
</script>

{% endblock %}
