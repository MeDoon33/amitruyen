{% extends "base.html" %} {% block title %}ƒêƒÉng Truy·ªán{% endblock %} {% block
content %}
<div class="container">
  <h1 class="my-4">Th√™m Truy·ªán M·ªõi</h1>
  <form
    method="POST"
    action="{{ url_for('admin.upload_comic') }}"
    enctype="multipart/form-data"
  >
    <div class="mb-3">
      <label for="title" class="form-label">Ti√™u ƒê·ªÅ</label>
      <input
        type="text"
        class="form-control"
        id="title"
        name="title"
        required
      />
    </div>
    <div class="mb-3">
      <label for="author" class="form-label">T√°c Gi·∫£</label>
      <input type="text" class="form-control" id="author" name="author" />
    </div>
    <div class="mb-3">
      <label for="description" class="form-label">M√¥ T·∫£</label>
      <textarea
        class="form-control"
        id="description"
        name="description"
        rows="3"
      ></textarea>
    </div>
    <div class="mb-3">
      <label class="form-label">·∫¢nh B√¨a</label>

      <!-- Tab navigation -->
      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="upload-tab"
            data-bs-toggle="tab"
            data-bs-target="#upload-panel"
            type="button"
            role="tab"
          >
            üì§ Upload t·ª´ m√°y
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="url-tab"
            data-bs-toggle="tab"
            data-bs-target="#url-panel"
            type="button"
            role="tab"
          >
            üîó D√πng URL
          </button>
        </li>
      </ul>

      <!-- Tab content -->
      <div class="tab-content border border-top-0 p-3">
        <!-- Upload panel -->
        <div
          class="tab-pane fade show active"
          id="upload-panel"
          role="tabpanel"
        >
          <input
            type="file"
            class="form-control"
            id="cover_file"
            name="cover_file"
            accept="image/png,image/jpeg,image/jpg,image/gif,image/webp"
            onchange="previewImage(this)"
          />
          <small class="text-muted d-block mt-2">
            <i class="fas fa-info-circle"></i>
            Upload l√™n ImgBB (cloud mi·ªÖn ph√≠). H·ªó tr·ª£: PNG, JPG, GIF, WEBP. T·ªëi
            ƒëa 10MB.
          </small>

          <!-- Image preview -->
          <div id="image-preview" class="mt-3" style="display: none">
            <p class="mb-2"><strong>Preview:</strong></p>
            <img
              id="preview-img"
              src=""
              alt="Preview"
              class="img-thumbnail"
              style="max-width: 300px; max-height: 400px"
            />
            <p class="text-muted small mt-2" id="file-info"></p>
          </div>
        </div>

        <!-- URL panel -->
        <div class="tab-pane fade" id="url-panel" role="tabpanel">
          <input
            type="text"
            class="form-control"
            id="cover_image"
            name="cover_image"
            placeholder="https://i.imgur.com/example.jpg"
          />
          <small class="text-muted d-block mt-2">
            <i class="fas fa-link"></i>
            Nh·∫≠p URL tr·ª±c ti·∫øp ƒë·∫øn ·∫£nh b√¨a (t·ª´ Imgur, Google Drive...)
          </small>
        </div>
      </div>
    </div>
    <div class="mb-3">
      <label for="genre" class="form-label">Th·ªÉ Lo·∫°i</label>
      <input type="text" class="form-control" id="genre" name="genre" />
    </div>
    <div class="mb-3">
      <label for="content_type" class="form-label">Lo·∫°i N·ªôi Dung</label>
      <select class="form-select" id="content_type" name="content_type">
        <option value="comic">Truy·ªán Tranh</option>
        <option value="novel">Truy·ªán Ch·ªØ</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="status" class="form-label">Tr·∫°ng Th√°i</label>
      <select class="form-select" id="status" name="status">
        <option value="ongoing">ƒêang Ra</option>
        <option value="completed">Ho√†n Th√†nh</option>
        <option value="hiatus">T·∫°m D·ª´ng</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="tags" class="form-label">Th·∫ª (ƒê·ªô tu·ªïi)</label>
      <input type="text" class="form-control" id="tags" name="tags" />
    </div>
    <!-- Duplicate Check Alert -->
    <div id="duplicate-alert" class="alert alert-warning d-none" role="alert">
      <h6>
        <i class="fas fa-exclamation-triangle"></i> Ph√°t hi·ªán truy·ªán t∆∞∆°ng t·ª±!
      </h6>
      <div id="duplicate-list"></div>
    </div>

    <button type="submit" class="btn btn-primary" id="submit-btn">
      T·∫°o Truy·ªán
    </button>
  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const titleInput = document.getElementById("title");
    const authorInput = document.getElementById("author");
    const duplicateAlert = document.getElementById("duplicate-alert");
    const duplicateList = document.getElementById("duplicate-list");
    const submitBtn = document.getElementById("submit-btn");

    let checkTimeout;

    function checkDuplicates() {
      const title = titleInput.value.trim();
      const author = authorInput.value.trim();

      if (title.length < 3) {
        duplicateAlert.classList.add("d-none");
        return;
      }

      // Debounce API call
      clearTimeout(checkTimeout);
      checkTimeout = setTimeout(() => {
        fetch("/admin/check-duplicate", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ title, author }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.duplicates && data.duplicates.length > 0) {
              duplicateAlert.classList.remove("d-none");
              duplicateList.innerHTML = data.duplicates
                .map(
                  (comic) =>
                    `<div class="mb-1">
                            <strong>"${comic.title}"</strong> by ${
                      comic.author || "Kh√¥ng r√µ"
                    }
                            <a href="/comic/${
                              comic.id
                            }" target="_blank" class="btn btn-sm btn-outline-primary ms-2">Xem</a>
                        </div>`
                )
                .join("");

              if (data.exact_duplicate) {
                submitBtn.disabled = true;
                submitBtn.textContent = "Truy·ªán ƒë√£ t·ªìn t·∫°i";
                duplicateAlert.classList.remove("alert-warning");
                duplicateAlert.classList.add("alert-danger");
              } else {
                submitBtn.disabled = false;
                submitBtn.textContent = "T·∫°o Truy·ªán";
                duplicateAlert.classList.remove("alert-danger");
                duplicateAlert.classList.add("alert-warning");
              }
            } else {
              duplicateAlert.classList.add("d-none");
              submitBtn.disabled = false;
              submitBtn.textContent = "T·∫°o Truy·ªán";
            }
          })
          .catch((error) => console.error("Error:", error));
      }, 500);
    }

    titleInput.addEventListener("input", checkDuplicates);
    authorInput.addEventListener("input", checkDuplicates);
  });
</script>

<script>
  // Image preview function
  function previewImage(input) {
    const preview = document.getElementById("image-preview");
    const previewImg = document.getElementById("preview-img");
    const fileInfo = document.getElementById("file-info");

    if (input.files && input.files[0]) {
      const file = input.files[0];
      const reader = new FileReader();

      // Display file info
      const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
      fileInfo.textContent = `üìÅ ${file.name} (${sizeMB} MB)`;

      // Check file size
      if (file.size > 10 * 1024 * 1024) {
        alert("‚ö†Ô∏è File qu√° l·ªõn! Vui l√≤ng ch·ªçn file d∆∞·ªõi 10MB.");
        input.value = "";
        preview.style.display = "none";
        return;
      }

      reader.onload = function (e) {
        previewImg.src = e.target.result;
        preview.style.display = "block";
      };

      reader.readAsDataURL(file);
    } else {
      preview.style.display = "none";
    }
  }
</script>

{% endblock %}
